<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DataForge AI ‚Äî E-Commerce Data Engineering</title>
<meta name="description" content="Intelligent data engineering platform with prompt engineering for e-commerce analytics">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e1a;--surface:#111827;--surface2:#1e293b;--surface3:#252f45;--border:#2d3a52;--text:#e2e8f0;--text2:#94a3b8;--accent:#6366f1;--accent2:#818cf8;--green:#10b981;--red:#ef4444;--orange:#f59e0b;--cyan:#06b6d4;--pink:#ec4899;--radius:12px;--glass:rgba(17,24,39,.7)}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
/* Animated bg */
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(ellipse at 20% 50%,rgba(99,102,241,.08),transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(6,182,212,.06),transparent 50%),radial-gradient(ellipse at 50% 80%,rgba(236,72,153,.05),transparent 50%);z-index:0;pointer-events:none}
.app{display:flex;min-height:100vh;position:relative;z-index:1}
/* Sidebar */
.sidebar{width:260px;background:var(--glass);backdrop-filter:blur(20px);border-right:1px solid var(--border);padding:20px 0;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:10}
.logo{padding:0 24px 24px;border-bottom:1px solid var(--border)}
.logo h1{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo p{font-size:11px;color:var(--text2);margin-top:4px;letter-spacing:.5px;text-transform:uppercase}
.nav{flex:1;padding:16px 12px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:12px;padding:10px 16px;border-radius:10px;cursor:pointer;color:var(--text2);font-size:13px;font-weight:500;transition:all .2s;margin-bottom:2px}
.nav-item:hover,.nav-item.active{background:rgba(99,102,241,.12);color:var(--text)}
.nav-item.active{border-left:3px solid var(--accent);color:var(--accent2)}
.nav-item .icon{font-size:18px;width:24px;text-align:center}
/* Main */
.main{flex:1;margin-left:260px;padding:24px 32px}
.page{display:none}
.page.active{display:block}
.page-header{margin-bottom:24px}
.page-header h2{font-size:22px;font-weight:700}
.page-header p{color:var(--text2);font-size:13px;margin-top:4px}
/* KPI Cards */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:28px}
.kpi-card{background:var(--glass);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:transform .2s,box-shadow .2s}
.kpi-card:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(99,102,241,.15)}
.kpi-label{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.kpi-value{font-size:28px;font-weight:800;margin:8px 0 4px;background:linear-gradient(135deg,var(--accent),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.kpi-sub{font-size:11px;color:var(--green)}
/* Charts */
.chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}
.chart-card{background:var(--glass);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.chart-card h3{font-size:14px;font-weight:600;margin-bottom:16px;color:var(--text2)}
.chart-card canvas{max-height:280px}
/* Prompt Studio */
.prompt-box{background:var(--glass);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:20px}
.prompt-input-row{display:flex;gap:12px;margin-bottom:16px}
.prompt-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 16px;color:var(--text);font-size:14px;font-family:'Inter',sans-serif;outline:none;transition:border-color .2s}
.prompt-input:focus{border-color:var(--accent)}
.prompt-btn{padding:12px 24px;border-radius:10px;border:none;font-weight:600;font-size:13px;cursor:pointer;transition:all .2s;font-family:'Inter',sans-serif}
.btn-primary{background:linear-gradient(135deg,var(--accent),#4f46e5);color:#fff}
.btn-primary:hover{box-shadow:0 4px 20px rgba(99,102,241,.4);transform:translateY(-1px)}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.prompt-tabs{display:flex;gap:8px;margin-bottom:16px}
.prompt-tab{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;background:var(--surface2);color:var(--text2);border:1px solid transparent;transition:all .2s}
.prompt-tab.active{background:rgba(99,102,241,.15);color:var(--accent2);border-color:var(--accent)}
.result-box{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-top:12px}
.result-box pre{font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.6;white-space:pre-wrap;color:var(--cyan)}
.reasoning-box{background:rgba(99,102,241,.05);border:1px solid rgba(99,102,241,.2);border-radius:8px;padding:12px;margin-top:12px}
.reasoning-box h4{font-size:12px;color:var(--accent2);margin-bottom:8px}
.reasoning-box p{font-size:12px;color:var(--text2);line-height:1.5}
/* Data table */
.data-table-wrap{overflow-x:auto;margin-top:12px}
table{width:100%;border-collapse:collapse;font-size:12px}
th{background:var(--surface2);color:var(--text2);text-transform:uppercase;font-size:10px;letter-spacing:.5px;padding:10px 12px;text-align:left;position:sticky;top:0}
td{padding:8px 12px;border-bottom:1px solid var(--border);color:var(--text)}
tr:hover td{background:rgba(99,102,241,.05)}
/* Pipeline */
.pipeline-dag{display:flex;align-items:center;gap:0;margin:24px 0;flex-wrap:wrap;justify-content:center}
.stage-node{background:var(--glass);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;text-align:center;min-width:140px;transition:all .3s}
.stage-node.completed{border-color:var(--green);box-shadow:0 0 20px rgba(16,185,129,.15)}
.stage-node.running{border-color:var(--orange);animation:pulse 1.5s infinite}
.stage-node .stage-icon{font-size:24px;margin-bottom:6px}
.stage-node .stage-name{font-size:12px;font-weight:600}
.stage-node .stage-status{font-size:10px;color:var(--text2);margin-top:4px}
.stage-arrow{color:var(--border);font-size:20px;margin:0 4px}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
/* Profile */
.profile-card{background:var(--glass);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.profile-card h4{font-size:13px;font-weight:600;margin-bottom:8px}
.stat-row{display:flex;justify-content:space-between;padding:4px 0;font-size:12px;border-bottom:1px solid rgba(45,58,82,.5)}
.stat-row .label{color:var(--text2)}.stat-row .value{font-weight:600;color:var(--cyan)}
.quality-bar{height:6px;border-radius:3px;background:var(--surface2);margin-top:8px;overflow:hidden}
.quality-bar-fill{height:100%;border-radius:3px;transition:width .6s ease}
/* Suggestions */
.suggestions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.suggestion{padding:6px 14px;border-radius:20px;font-size:11px;background:rgba(99,102,241,.1);color:var(--accent2);cursor:pointer;border:1px solid rgba(99,102,241,.2);transition:all .2s}
.suggestion:hover{background:rgba(99,102,241,.2)}
/* Loading */
.loader{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.badge{display:inline-block;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600}
.badge-green{background:rgba(16,185,129,.15);color:var(--green)}
.badge-orange{background:rgba(245,158,11,.15);color:var(--orange)}
.badge-red{background:rgba(239,68,68,.15);color:var(--red)}
@media(max-width:900px){.sidebar{display:none}.main{margin-left:0}.chart-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="logo"><h1>‚ö° DataForge AI</h1><p>E-Commerce Data Engineering</p></div>
    <nav class="nav">
      <div class="nav-item active" data-page="dashboard"><span class="icon">üìä</span>Dashboard</div>
      <div class="nav-item" data-page="prompt"><span class="icon">üß†</span>Prompt Studio</div>
      <div class="nav-item" data-page="pipeline"><span class="icon">üîÑ</span>Pipeline</div>
      <div class="nav-item" data-page="profiler"><span class="icon">üîç</span>Data Profiler</div>
      <div class="nav-item" data-page="quality"><span class="icon">‚úÖ</span>Quality Monitor</div>
      <div class="nav-item" data-page="explorer"><span class="icon">üìÅ</span>Data Explorer</div>
    </nav>
    <div style="padding:16px 24px;border-top:1px solid var(--border)">
      <div style="font-size:10px;color:var(--text2)">POWERED BY</div>
      <div style="font-size:12px;font-weight:600;color:var(--accent2);margin-top:2px">Prompt Engineering</div>
    </div>
  </aside>

  <main class="main">
    <!-- DASHBOARD PAGE -->
    <section class="page active" id="page-dashboard">
      <div class="page-header"><h2>üìä Analytics Dashboard</h2><p>Real-time e-commerce performance metrics</p></div>
      <div class="kpi-grid" id="kpi-grid"></div>
      <div class="chart-grid">
        <div class="chart-card"><h3>üìà Revenue Trend</h3><canvas id="chart-trend"></canvas></div>
        <div class="chart-card"><h3>üè∑Ô∏è Revenue by Category</h3><canvas id="chart-category"></canvas></div>
        <div class="chart-card"><h3>üåç Revenue by Region</h3><canvas id="chart-region"></canvas></div>
        <div class="chart-card"><h3>üì¶ Order Status</h3><canvas id="chart-status"></canvas></div>
      </div>
    </section>

    <!-- PROMPT STUDIO PAGE -->
    <section class="page" id="page-prompt">
      <div class="page-header"><h2>üß† Prompt Studio</h2><p>Natural language ‚Üí SQL, Transformations & Quality Rules</p></div>
      <div class="prompt-box">
        <div class="prompt-tabs">
          <div class="prompt-tab active" data-type="sql">Prompt ‚Üí SQL</div>
          <div class="prompt-tab" data-type="transform">Prompt ‚Üí Transform</div>
          <div class="prompt-tab" data-type="quality">Prompt ‚Üí Quality Rules</div>
        </div>
        <div class="prompt-input-row">
          <input class="prompt-input" id="prompt-input" placeholder="e.g. Show top 10 products by revenue..." />
          <button class="prompt-btn btn-primary" id="prompt-run">‚ö° Generate</button>
        </div>
        <div class="suggestions" id="prompt-suggestions"></div>
        <div id="prompt-result"></div>
      </div>
    </section>

    <!-- PIPELINE PAGE -->
    <section class="page" id="page-pipeline">
      <div class="page-header"><h2>üîÑ Pipeline Orchestrator</h2><p>ETL pipeline stages and execution history</p></div>
      <div class="prompt-box">
        <div class="pipeline-dag" id="pipeline-dag"></div>
        <div style="text-align:center;margin-top:16px">
          <button class="prompt-btn btn-primary" id="run-pipeline-btn">‚ñ∂Ô∏è Run Pipeline</button>
        </div>
      </div>
      <div id="pipeline-results"></div>
      <div class="chart-card" style="margin-top:20px"><h3>üìú Recent Runs</h3><div id="pipeline-history"></div></div>
    </section>

    <!-- PROFILER PAGE -->
    <section class="page" id="page-profiler">
      <div class="page-header"><h2>üîç Data Profiler</h2><p>Statistical analysis and column-level insights</p></div>
      <div class="prompt-input-row" style="margin-bottom:20px">
        <select class="prompt-input" id="profile-table" style="max-width:300px">
          <option value="">Select a table...</option>
        </select>
        <button class="prompt-btn btn-primary" id="profile-btn">Profile Table</button>
      </div>
      <div id="profile-results"></div>
    </section>

    <!-- QUALITY PAGE -->
    <section class="page" id="page-quality">
      <div class="page-header"><h2>‚úÖ Quality Monitor</h2><p>Data quality rules and anomaly detection</p></div>
      <div class="prompt-box">
        <div class="prompt-input-row">
          <input class="prompt-input" id="quality-input" placeholder="e.g. Check for missing values and duplicates..." />
          <button class="prompt-btn btn-primary" id="quality-btn">üîé Analyze</button>
        </div>
      </div>
      <div id="quality-results"></div>
    </section>

    <!-- EXPLORER PAGE -->
    <section class="page" id="page-explorer">
      <div class="page-header"><h2>üìÅ Data Explorer</h2><p>Browse and query e-commerce datasets</p></div>
      <div class="prompt-box">
        <div class="prompt-input-row">
          <input class="prompt-input" id="sql-input" placeholder="SELECT * FROM orders LIMIT 10" style="font-family:'JetBrains Mono',monospace;font-size:13px" />
          <button class="prompt-btn btn-primary" id="sql-btn">‚ñ∂Ô∏è Execute</button>
        </div>
      </div>
      <div id="explorer-results"></div>
      <div class="chart-card" style="margin-top:20px"><h3>üìã Database Tables</h3><div id="tables-list"></div></div>
    </section>
  </main>
</div>

<script>
const API = '';
const chartColors = ['#6366f1','#06b6d4','#10b981','#f59e0b','#ec4899','#8b5cf6','#ef4444','#14b8a6'];
const chartDefaults = {responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8',font:{family:'Inter',size:11}}}}};
Chart.defaults.color='#94a3b8';Chart.defaults.borderColor='#2d3a52';

// Navigation
document.querySelectorAll('.nav-item').forEach(item=>{
  item.addEventListener('click',()=>{
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    item.classList.add('active');
    document.getElementById('page-'+item.dataset.page).classList.add('active');
    if(item.dataset.page==='dashboard')loadDashboard();
    if(item.dataset.page==='pipeline')loadPipeline();
    if(item.dataset.page==='profiler')loadTables();
    if(item.dataset.page==='explorer'){loadTables();loadTablesList();}
  });
});

// Format currency
const fmt=n=>'$'+Number(n).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0});

// ===================== DASHBOARD =====================
let charts={};
async function loadDashboard(){
  const data=await fetch(API+'/api/dashboard/kpis').then(r=>r.json());
  document.getElementById('kpi-grid').innerHTML=[
    kpiCard('Total Revenue',fmt(data.total_revenue),'üí∞','‚Üë from all orders'),
    kpiCard('Orders',data.total_orders.toLocaleString(),'üì¶',data.total_products+' products'),
    kpiCard('Customers',data.total_customers.toLocaleString(),'üë•','across 5 regions'),
    kpiCard('Avg Order Value',fmt(data.avg_order_value),'üìà','per transaction'),
  ].join('');
  renderCharts(data);
}
function kpiCard(label,value,icon,sub){
  return `<div class="kpi-card"><div class="kpi-label">${icon} ${label}</div><div class="kpi-value">${value}</div><div class="kpi-sub">${sub}</div></div>`;
}
function renderCharts(data){
  Object.values(charts).forEach(c=>c.destroy());charts={};
  // Revenue Trend
  charts.trend=new Chart(document.getElementById('chart-trend'),{type:'line',data:{labels:data.monthly_trend.map(m=>m.month),datasets:[{label:'Revenue',data:data.monthly_trend.map(m=>m.revenue),borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,.1)',fill:true,tension:.4,pointRadius:3}]},options:{...chartDefaults,scales:{y:{ticks:{callback:v=>'$'+v.toLocaleString()},grid:{color:'#1e293b'}},x:{grid:{display:false}}}}});
  // Category
  charts.category=new Chart(document.getElementById('chart-category'),{type:'doughnut',data:{labels:data.revenue_by_category.map(c=>c.name),datasets:[{data:data.revenue_by_category.map(c=>c.revenue),backgroundColor:chartColors}]},options:{...chartDefaults}});
  // Region
  charts.region=new Chart(document.getElementById('chart-region'),{type:'bar',data:{labels:data.revenue_by_region.map(r=>r.name),datasets:[{label:'Revenue',data:data.revenue_by_region.map(r=>r.revenue),backgroundColor:chartColors.map(c=>c+'cc'),borderRadius:6}]},options:{...chartDefaults,scales:{y:{ticks:{callback:v=>'$'+v.toLocaleString()},grid:{color:'#1e293b'}},x:{grid:{display:false}}}}});
  // Status
  charts.status=new Chart(document.getElementById('chart-status'),{type:'pie',data:{labels:data.order_status.map(s=>s.status),datasets:[{data:data.order_status.map(s=>s.count),backgroundColor:chartColors}]},options:{...chartDefaults}});
}

// ===================== PROMPT STUDIO =====================
let promptType='sql';
const suggestions={sql:['Show top 10 products by revenue','Revenue by category','Monthly revenue trend','Top 5 customers by spending','Order status breakdown','Revenue by region','Product ratings overview','Profit analysis','Payment method distribution','Inventory status'],transform:['Clean null values in dataset','Normalize price fields','Aggregate revenue by month','RFM customer segmentation','Remove duplicate records','Extract date features'],quality:['Check for missing values','Validate data consistency','Check uniqueness constraints','Verify value ranges','Full quality assessment']};

document.querySelectorAll('.prompt-tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.prompt-tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    promptType=tab.dataset.type;
    renderSuggestions();
    document.getElementById('prompt-result').innerHTML='';
  });
});
function renderSuggestions(){
  document.getElementById('prompt-suggestions').innerHTML=suggestions[promptType].map(s=>`<div class="suggestion" onclick="runPrompt('${s.replace(/'/g,"\\'")}')">${s}</div>`).join('');
}
renderSuggestions();

document.getElementById('prompt-run').addEventListener('click',()=>runPrompt(document.getElementById('prompt-input').value));
document.getElementById('prompt-input').addEventListener('keydown',e=>{if(e.key==='Enter')runPrompt(e.target.value)});

async function runPrompt(text){
  if(!text)return;
  document.getElementById('prompt-input').value=text;
  document.getElementById('prompt-result').innerHTML='<div class="loader"></div> Generating...';
  const res=await fetch(API+'/api/prompt/'+promptType,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:text})}).then(r=>r.json());
  
  let html='';
  if(promptType==='sql'){
    html+=`<div class="result-box"><h4 style="font-size:12px;color:var(--accent2);margin-bottom:8px">üìù Generated SQL</h4><pre>${escHtml(res.generated.sql)}</pre></div>`;
    html+=`<div class="reasoning-box"><h4>üß† Chain-of-Thought Reasoning</h4><p>${res.generated.reasoning.join('<br>')}</p><p style="margin-top:6px;color:var(--pink)">Technique: ${res.generated.prompt_technique}</p></div>`;
    if(res.result&&res.result.rows&&res.result.rows.length>0){
      html+=`<div style="margin-top:12px"><h4 style="font-size:12px;color:var(--green);margin-bottom:8px">üìä Query Results (${res.result.row_count} rows)</h4>`;
      html+=renderTable(res.result.columns,res.result.rows);
      html+='</div>';
    }
  }else if(promptType==='transform'){
    const t=res.generated.transformation;
    html+=`<div class="result-box"><h4 style="font-size:12px;color:var(--accent2);margin-bottom:8px">üîß ${t.name}</h4><p style="color:var(--text2);font-size:12px;margin-bottom:12px">${t.description}</p>`;
    html+=`<h4 style="font-size:11px;color:var(--orange);margin-bottom:6px">Steps:</h4><ol style="font-size:12px;padding-left:20px;color:var(--text2)">${t.steps.map(s=>`<li style="margin-bottom:4px">${s}</li>`).join('')}</ol>`;
    html+=`<h4 style="font-size:11px;color:var(--cyan);margin:12px 0 6px">Generated Code:</h4><pre>${escHtml(t.code)}</pre></div>`;
    html+=`<div class="reasoning-box"><h4>üß† Reasoning</h4><p>${res.generated.reasoning.join('<br>')}</p></div>`;
  }else if(promptType==='quality'){
    const rules=res.generated.quality_rules;
    for(const[cat,info]of Object.entries(rules)){
      html+=`<div class="profile-card"><h4>${info.name}</h4><p style="font-size:11px;color:var(--text2);margin-bottom:8px">${info.description}</p>`;
      info.rules.forEach(r=>{
        const badgeClass=r.severity==='critical'?'badge-red':r.severity==='high'?'badge-orange':'badge-green';
        html+=`<div class="stat-row"><span class="label">${r.field}: ${r.rule}</span><span class="badge ${badgeClass}">${r.severity}</span></div>`;
      });
      html+='</div>';
    }
    html+=`<div class="reasoning-box"><h4>üß† Reasoning</h4><p>${res.generated.reasoning.join('<br>')}</p><p style="margin-top:4px;color:var(--cyan)">Total rules: ${res.generated.total_rules}</p></div>`;
  }
  document.getElementById('prompt-result').innerHTML=html;
}

// ===================== PIPELINE =====================
const stageIcons={ingest:'üì•',validate:'‚úîÔ∏è',profile:'üìä',transform:'üîß',quality_check:'‚úÖ',export:'üì§'};
async function loadPipeline(){
  const data=await fetch(API+'/api/pipeline/status').then(r=>r.json());
  let dag='';
  data.stages.forEach((s,i)=>{
    dag+=`<div class="stage-node"><div class="stage-icon">${stageIcons[s]||'‚öôÔ∏è'}</div><div class="stage-name">${s.replace('_',' ')}</div><div class="stage-status">${data.stage_descriptions[s]?.substring(0,40)||''}...</div></div>`;
    if(i<data.stages.length-1)dag+=`<div class="stage-arrow">‚Üí</div>`;
  });
  document.getElementById('pipeline-dag').innerHTML=dag;
  if(data.recent_runs.length){
    document.getElementById('pipeline-history').innerHTML=renderTable(['id','pipeline_name','status','started_at','records_processed','errors'],data.recent_runs);
  }else{
    document.getElementById('pipeline-history').innerHTML='<p style="color:var(--text2);font-size:13px;padding:12px">No pipeline runs yet. Click "Run Pipeline" to start.</p>';
  }
}

document.getElementById('run-pipeline-btn').addEventListener('click',async()=>{
  document.getElementById('pipeline-results').innerHTML='<div style="padding:16px"><div class="loader"></div> Running pipeline...</div>';
  const res=await fetch(API+'/api/pipeline/run',{method:'POST'}).then(r=>r.json());
  let html='<div class="chart-card" style="margin-top:16px"><h3>‚úÖ Pipeline Run #'+res.run_id+' Complete</h3>';
  html+=`<div class="kpi-grid" style="margin-top:12px">`;
  html+=kpiCard('Records',''+res.total_records,'üì¶','processed');
  html+=kpiCard('Errors',''+res.total_errors,'‚ö†Ô∏è',res.total_errors===0?'No issues':'needs review');
  html+=kpiCard('Status',res.status,'‚úÖ','all stages');
  html+='</div>';
  for(const[stage,info]of Object.entries(res.stages)){
    html+=`<div class="profile-card"><h4>${stageIcons[stage]||'‚öôÔ∏è'} ${stage.replace('_',' ')}</h4>`;
    for(const[k,v]of Object.entries(info)){
      if(k!=='status')html+=`<div class="stat-row"><span class="label">${k.replace(/_/g,' ')}</span><span class="value">${Array.isArray(v)?v.join(', '):v}</span></div>`;
    }
    html+='</div>';
  }
  html+='</div>';
  document.getElementById('pipeline-results').innerHTML=html;
  // Highlight DAG
  document.querySelectorAll('.stage-node').forEach(n=>n.classList.add('completed'));
  loadPipeline();
});

// ===================== PROFILER =====================
async function loadTables(){
  const data=await fetch(API+'/api/tables').then(r=>r.json());
  const sel=document.getElementById('profile-table');
  sel.innerHTML='<option value="">Select a table...</option>'+data.tables.filter(t=>!['datasets','pipeline_runs'].includes(t.name)).map(t=>`<option value="${t.name}">${t.name} (${t.rows} rows, ${t.columns} cols)</option>`).join('');
}

document.getElementById('profile-btn').addEventListener('click',async()=>{
  const table=document.getElementById('profile-table').value;
  if(!table)return;
  document.getElementById('profile-results').innerHTML='<div class="loader"></div> Profiling...';
  const data=await fetch(API+'/api/profile/'+table).then(r=>r.json());
  let html=`<div class="kpi-grid"><div class="kpi-card"><div class="kpi-label">Rows</div><div class="kpi-value">${data.row_count}</div></div><div class="kpi-card"><div class="kpi-label">Columns</div><div class="kpi-value">${data.column_count}</div></div><div class="kpi-card"><div class="kpi-label">Quality Score</div><div class="kpi-value">${data.quality_score}%</div><div class="quality-bar"><div class="quality-bar-fill" style="width:${data.quality_score}%;background:${data.quality_score>80?'var(--green)':data.quality_score>60?'var(--orange)':'var(--red)'}"></div></div></div></div>`;
  data.columns.forEach(col=>{
    html+=`<div class="profile-card"><h4>${col.name} <span class="badge badge-green">${col.type||'TEXT'}</span></h4>`;
    html+=`<div class="stat-row"><span class="label">Nulls</span><span class="value">${col.null_count} (${col.null_pct}%)</span></div>`;
    html+=`<div class="stat-row"><span class="label">Distinct</span><span class="value">${col.distinct_count}</span></div>`;
    if(col.min!==undefined)html+=`<div class="stat-row"><span class="label">Min / Max</span><span class="value">${col.min} / ${col.max}</span></div>`;
    if(col.mean!==undefined)html+=`<div class="stat-row"><span class="label">Mean</span><span class="value">${col.mean}</span></div>`;
    if(col.sample_values)html+=`<div class="stat-row"><span class="label">Samples</span><span class="value" style="font-size:11px">${col.sample_values.join(', ')}</span></div>`;
    html+='</div>';
  });
  document.getElementById('profile-results').innerHTML=html;
});

// ===================== QUALITY =====================
document.getElementById('quality-btn').addEventListener('click',async()=>{
  const text=document.getElementById('quality-input').value||'full quality assessment';
  document.getElementById('quality-results').innerHTML='<div class="loader"></div> Analyzing...';
  const res=await fetch(API+'/api/prompt/quality',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:text})}).then(r=>r.json());
  let html='';
  const rules=res.generated.quality_rules;
  for(const[cat,info]of Object.entries(rules)){
    html+=`<div class="profile-card"><h4>${info.name}</h4><p style="font-size:11px;color:var(--text2);margin-bottom:8px">${info.description}</p>`;
    info.rules.forEach(r=>{
      const bc=r.severity==='critical'?'badge-red':r.severity==='high'?'badge-orange':'badge-green';
      html+=`<div class="stat-row"><span class="label">${r.field}: ${r.rule}</span><span class="badge ${bc}">${r.severity}</span></div>`;
    });
    html+='</div>';
  }
  html+=`<div class="reasoning-box"><h4>üß† Reasoning</h4><p>${res.generated.reasoning.join('<br>')}</p></div>`;
  document.getElementById('quality-results').innerHTML=html;
});

// ===================== EXPLORER =====================
document.getElementById('sql-btn').addEventListener('click',async()=>{
  const sql=document.getElementById('sql-input').value;
  if(!sql)return;
  document.getElementById('explorer-results').innerHTML='<div class="loader"></div> Executing...';
  const res=await fetch(API+'/api/query/execute',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sql})}).then(r=>r.json());
  if(res.error){document.getElementById('explorer-results').innerHTML=`<div class="result-box" style="border-color:var(--red)"><pre style="color:var(--red)">Error: ${escHtml(res.error)}</pre></div>`;return;}
  document.getElementById('explorer-results').innerHTML=`<p style="font-size:12px;color:var(--green);margin-bottom:8px">‚úÖ ${res.row_count} rows returned${res.truncated?' (truncated)':''}</p>`+renderTable(res.columns,res.rows);
});
document.getElementById('sql-input').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('sql-btn').click()});

async function loadTablesList(){
  const data=await fetch(API+'/api/tables').then(r=>r.json());
  document.getElementById('tables-list').innerHTML=renderTable(['name','rows','columns'],data.tables);
}

// ===================== HELPERS =====================
function renderTable(cols,rows){
  if(!rows||!rows.length)return'<p style="color:var(--text2);font-size:12px">No data</p>';
  let h='<div class="data-table-wrap"><table><thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>';
  rows.forEach(r=>{h+='<tr>'+cols.map(c=>{let v=r[c];if(v===null||v===undefined)v='<span style="color:var(--text2)">null</span>';return`<td>${v}</td>`;}).join('')+'</tr>';});
  h+='</tbody></table></div>';return h;
}
function escHtml(s){if(!s)return'';return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// Init
loadDashboard();
</script>
</body>
</html>
